# Network Upgrade & Migration: TestNet

## Upgrading from und v1.4.8 (Cosmos SDK 0.38) to und v1.5.0 (Cosmos SDK 0.42)

This guide assumes the `und` binary is running with `systemd` and that the user logging in via SSH is a `sudoer`.

**Validator nodes will be responsible for setting the chain `halt-time` and running the initial upgrade,
genesis export and genesis migration to the Cosmos SDK 0.42 format.
Other nodes (for example sentries, RPCs etc.) can then follow suit
and use the new `genesis.json` generated by the validator(s).**

## 1. Governance Proposal

See TestNet [Proposal #3](https://explorer-testnet.unification.io/proposals/3)

Full proposal text: [https://ipfs.io/ipfs/QmexYgqpYcQzzxuc1zo6zHVmHcXoQ72KRP5Lqkn4PuTC54](https://ipfs.io/ipfs/QmexYgqpYcQzzxuc1zo6zHVmHcXoQ72KRP5Lqkn4PuTC54)

**Halt time:** 1646913600 (Thu Mar 10 2022 12:00:00 GMT+0000)  
**New Genesis time:** 2022-03-10T14:00:00Z  
**New Chain ID:** FUND-TestNet-2

## 2. Validator Nodes: Pre-upgrade preparation

### Validators will need to configure the `halt-time` of their node before the proposed halt time

**Important** ONLY VALIDATOR NODES NEED TO SET THIS. 
Do not set for sentries/RPCs etc. as they will need to propagate the final block signatures to other validators (for example, those behind sentry nodes)

Edit your validator's `app.toml` to define the specified `halt-time`. This is a Unix epoch timestamp, and will tell the node to gracefully stop producing blocks at the specified time.

**Important**: Ensure only the `halt-time` is set. **Do not** set `halt-height`.

```bash
nano .und_mainchain/config/app.toml
```

Set as per the governance proposal & save:

```
halt-time=1646913600
```

Next, in a separate terminal, monitor your node's logs to see when it's "safe" to restart

```bash
sudo journalctl -u und -f
```


wait for a `"Committed Block"` message, then restart to load the config updates:

```bash
sudo systemctl restart und
```

## 3. Validator Nodes: Upgrade Process (after halt time)

Near the specified `halt-time`, monitor your node's logs with either `journalctl` or by querying the service's status,
for example

```bash
sudo journalctl -u und -f
```

or

```bash
sudo systemctl status und -l -n 100
```

**Note**: you may need to increase the number of lines output `-n 100` in the above command.

At around the specified `halt-time` you should see the message:

```bash
halting node per configuration               module=main height=0 time=1646913600
Committed state                              module=state height=NNNNNN txs=0 appHash=ABC123...
```

(where `NNNNNN` is the last committed block number)

It is likely you will also see many warnings after this log output, such as

```bash
Connection failed @ recvRoutine (reading byte) ...
Stopping peer for error ...
...
```

This means that other nodes in your node's address book have likely (and hopefully) also halted at the specified time.

Once your node has cleanly halted as per the log message above, stop the `systemd` service:

```bash
sudo systemctl stop und
```

**BACKUP, BACKUP, BACKUP `.und_mainchain`**, for example:

```bash
rsync -av $HOME/.und_mainchain/ $HOME/und_mainchain_BAK/
```

Or

```bash
cd $HOME/.und_mainchain
tar -cpzf $HOME/und_mainchain.backup.tar.gz *
```

In the event the upgrade fails, the chain can be rolled back to `und` v1.4.8 and the old chain data.

**BACKUP** your node & validator keys, preferably offline.

download `und` v1.4.9. This can be to a temporary location, e.g. `/home/centos/und_1.4.9` as it will only be used for exporting the state to a new genesis:

```bash
cd $HOME
wget https://github.com/unification-com/mainchain/releases/download/1.4.9/und_v1.4.9_linux_x86_64.tar.gz
tar -zxvf und_v1.4.9_linux_x86_64.tar.gz
mv und und_1.4.9
```

Export the current chain state to the new genesis.  
**You must use `und` v1.4.9 to execute this**:

```bash
$HOME/und_1.4.9 export --for-zero-height --home=$HOME/.und_mainchain > $HOME/v038_exported_state.json
```

backup the old `und` and `undcli` 1.4.8 binaries, e.g.

```bash
mkdir -p /home/centos/UND_BIN_BACKUP
cp /usr/local/bin/und /home/centos/UND_BIN_BACKUP/und_1.4.8
cp /usr/local/bin/undcli /home/centos/UND_BIN_BACKUP/undcli_1.4.8
```

**IMPORTANT** `undcli` is no longer required since all the old `undcli` commands are not integrated into the single `und` binary. As such, it should be removed if it installed in a common location because it will not be compatible with `und` v1.5.0, for example:

```bash
sudo rm /usr/local/bin/undcli
```

download und v1.5.0 and install in `/usr/local/bin` or your preferred location, for example:

```bash
cd $HOME
wget https://github.com/unification-com/mainchain/releases/download/1.5.0/und_v1.5.0_linux_x86_64.tar.gz
tar -zxvf und_v1.5.0_linux_x86_64.tar.gz
sudo mv und /usr/local/bin/und
```

**IMPORTANT**: All commands from here require `und` v1.5.0

Ensure `und` is v1.5.0

```bash
/usr/local/bin/und version --long
```

Mirgate the exported genesis **using the `und` v1.5.0 binary**:

```bash
/usr/local/bin/und migrate $HOME/v038_exported_state.json --chain-id=FUND-TestNet-2 --genesis-time="2022-03-10T14:00:00Z" --log_level="" > $HOME/new_v042_genesis.json
```

**IMPORTANT** Set the `--log_level=""` in the command. Without it, log info will be output to the migrated genesis file!!


Validate the migrated genesis:

```
/usr/local/bin/und validate-genesis $HOME/new_v042_genesis.json
```

Generate a checksum and cross-reference with other operators in Discord/Telegram:

```bash
jq -S -c -M '' $HOME/new_v042_genesis.json | shasum -a 256
[SHASUM_PLACEHOLDER]  new_v042_genesis.json
```

Reset the chain data for your node:

```bash
/usr/local/bin/und unsafe-reset-all --home=$HOME/.und_mainchain
```

Copy the new genesis file to replace the old version in `.und_mainchain/config`:

```bash
cp $HOME/new_v042_genesis.json $HOME/.und_mainchain/config/genesis.json
```

Download the new 0.42 formatted `app.toml` and replace your old  version in `.und_mainchain/config`:

```bash
curl https://raw.githubusercontent.com/unification-com/testnet/master/latest/042_app.toml > $HOME/.und_mainchain/config/app.toml
```

Modify as required:

```bash
nano $HOME/.und_mainchain/config/app.toml
```

Change the `log_level` in `.und_mainchain/config/config.toml`, as the variable format has changed in Cosmos SDK 0.42.x:

```bash
nano $HOME/.und_mainchain/config/config.toml
```

and set:

```
log_level = "info"
```

**Note:** You may also want to check the changes to [`config.toml`](latest/042_config.toml), and apply any to your node.
The biggest changes are the addition of the `State Sync Configuration Options` section. **The version included
in this repo is for reference only and should not be used to overwrite your existing `config.toml`**!

Finally, start the node!

```bash
sudo systemctl start und
sudo journalctl -u und -f
```

**IMPORTANT**: Once the genesis time has been reached, and enough Validators are back online, the chain will begin producing blocks from block 1.
This may not occur until after the specified genesis time, as validators and sentries come back online and connect. Keep in contact with
other validator operators in Discord/Telegram to keep up to date with each others' upgrade status!

## 4. Sentries, RPCs, Seeds etc.

Once Validators have been configured and started, the genesis file can be copied over to other nodes. There is no need to export
and migrate the genesis on sentry/RPC/seed nodes.

Stop the node:

```bash
sudo systemctl stop und
```

Backup at least one full `.und_mainchain` if you have multiple sentries.

Backup the config directory for **all** sentry/rpc/seed nodes:

```bash
cd $HOME/.und_mainchain/config
tar -cpzf $HOME/und_mainchain.backup.tar.gz *
```

backup the old `und` and `undcli` v1.4.8 binaries, e.g.

```bash
mkdir -p /home/centos/UND_BIN_BACKUP
cp /usr/local/bin/und /home/centos/UND_BIN_BACKUP/und_1.4.8
cp /usr/local/bin/undcli /home/centos/UND_BIN_BACKUP/undcli_1.4.8
sudo rm /usr/local/bin/undcli
```

`undcli` is no longer required, so can be removed

download und v1.5.0 and install in `/usr/local/bin` or your preferred location:

```bash
cd $HOME
wget https://github.com/unification-com/mainchain/releases/download/1.5.0/und_v1.5.0_linux_x86_64.tar.gz
tar -zxvf und_v1.5.0_linux_x86_64.tar.gz
sudo mv und /usr/local/bin/und
```

**IMPORTANT**: All commands from here require `und` v1.5.0

Ensure it's v1.5.0

```bash
/usr/local/bin/und version --long
```

Reset the chain data for your node:

```bash
/usr/local/bin/und unsafe-reset-all --home=$HOME/.und_mainchain
```

Transfer/copy the new `genesis.json`, for example from your Validator node or Github once it's published.

Download and configure the `app.toml` for Cosmos 0.42 chains.

```bash
curl https://raw.githubusercontent.com/unification-com/testnet/master/latest/042_app.toml > $HOME/.und_mainchain/config/app.toml
```

Change the `log_level` in `config.toml`

```bash
nano $HOME/.und_mainchain/config/config.toml
```

and set:

```
log_level = "info"
```

Finally, start the node!

```bash
sudo systemctl start und
sudo journalctl -u und -f
```

## 5. Migrate keys

If you have any wallet keys in for example $HOME/.und_cli, or the OS keystore, they will need migrating.

Backup first - especially if you use the same keystore for both MN and TN

TODO - migration commands
